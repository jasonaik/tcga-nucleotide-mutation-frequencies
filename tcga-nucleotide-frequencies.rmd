---
title: "Most Common Mutations in Each Cancer Type (and Pan Cancer)"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

BiocManager::install("PoisonAlien/TCGAmutations")
library(TCGAmutations)
```


```{r load-mutations}
library(dplyr)
library(tidyverse)

cancer_data <- as.data.frame(tcga_available())
cancer_dfs <- tibble(
  cancer_name = character(),
  data = list()
)

cancer_dfs_facet <- tibble(
  cancer_name = character(),
  data = list()
)

for (i in seq_along(cancer_data$Study_Abbreviation)) {
  # Load TCGA mutation data
  cancer_type <- cancer_data$Study_Abbreviation[i]
  cancer_name <- gsub("_", " ", cancer_data$Study_Name[i])
  mutations <- tcgaLoad(study = cancer_type)
  mutation_data <- as.data.frame(mutations@data)
  nucleotide_changes <- mutation_data[, c("Hugo_Symbol", "HGVSc")]

  tumor_samples <- mutation_data[, c("Tumor_Sample_Barcode")]

  num_tumors <- length(unique(tumor_samples))

  # group_by HGVSc and add frequency using mutate, then ungroup
  df <- nucleotide_changes %>%
    mutate(mutation = paste(Hugo_Symbol, HGVSc, sep = ", ")) %>%
    group_by(mutation) %>%
    mutate(freq = n()) %>%
    ungroup()

  # sort in descending order, distinct removes duplicate rows
  df_sorted <- df %>%
    arrange(desc(freq)) %>%
    distinct(mutation, .keep_all = TRUE)

  df_merged <- df_sorted %>%
    select(mutation, freq) %>%
    mutate(cancer_name_internal = cancer_name) %>%
    mutate(cancer_type = cancer_type)

  df_merged_trunc <- df_merged[1:50, ]
  df_merged_trunc_facet <- df_merged[1:10, ]

  df_merged_trunc <- df_merged_trunc %>% mutate(mutation = str_trunc(mutation, 20))
  df_merged_trunc_facet <- df_merged_trunc_facet %>% mutate(mutation = str_trunc(mutation, 20))

  # Convert the mutation column to a factor
  df_merged_trunc$freq <- df_merged_trunc$freq / num_tumors

  df_merged_trunc_facet$freq <- df_merged_trunc_facet$freq / num_tumors

  # append dfs to list
  cancer_dfs <- cancer_dfs %>% add_row(cancer_name, data = list(df_merged_trunc))
  cancer_dfs_facet <- cancer_dfs_facet %>% add_row(cancer_name, data = list(df_merged_trunc_facet))
}
```

```{r plot-graphs, fig.width=20, fig.height=14, out.width='100%', dpi=150}
library(ggplot2)
library(purrr)
library(gridExtra)

# Create the bar plot
create_plot <- function(df, name) {
  ggplot(data = df, aes(x = mutation, y = freq)) + # nolint: object_usage_linter.
    geom_bar(stat = "identity", fill = "blue") +
    geom_text(aes(label = round(freq, 3)), size = 3.5, hjust = 1.2, color = "white") +
    coord_flip() +
    labs(x = "Mutation", y = "Frequency", title = paste("Frequency of Mutations in ", name, sep = "")) +
    theme_minimal()
}

plots <- pmap(cancer_dfs, function(cancer_name, data) {
  create_plot(data, cancer_name)
})

plots
```

```{r plot-facets, fig.width=20, fig.height=14, out.width='100%', dpi=150}
library(tidyverse)
library(tidytext)
library(glue)

# Split df into 4 because too big for one facet plot
cancer_types <- unique(cancer_dfs_facet$cancer_name)
plots_per_group <- 12
n_groups <- ceiling(length(cancer_types) / plots_per_group)
group_assignments <- rep(1:n_groups, each = plots_per_group)[seq_along(cancer_types)]
cancer_type_groups <- split(cancer_types, group_assignments)

create_facet_plot <- function(df_data, cancer_types_subset) {
  subset_data <- df_data %>% filter(cancer_name %in% cancer_types_subset) # nolint: object_usage_linter.

  list_of_tibbles <- subset_data$data
  combined_data <- bind_rows(list_of_tibbles)

  # Create plot
  ggplot(combined_data, aes(x = reorder_within(mutation, freq, cancer_type), y = freq)) + # nolint: object_usage_linter.
    geom_bar(stat = "identity", fill = "blue", width = 0.9) +
    geom_text(aes(label = round(freq, 3)), size = 1.5, hjust = 1.2, color = "white") +
    coord_flip() +
    labs(x = "Mutation", y = "Frequency") +
    facet_wrap(~cancer_type, scales = "free") +
    theme_minimal() +
    scale_x_reordered() +
    theme(
      axis.text.y = element_text(size = 7),
      axis.text.x = element_text(size = 5)
    )
}

# Create facet plots for each group of cancer types
facet_plots <- lapply(cancer_type_groups, function(cancer_types_subset) {
  create_facet_plot(cancer_dfs_facet, cancer_types_subset)
})


for (i in seq_along(facet_plots)) {
  pdf(glue("plots/facet_{i}.pdf"))
  print(facet_plots[[i]])
  dev.off()
}

print(facet_plots[[i]])
```

```{r plot-one-facet, fig.width=20, fig.height=14, out.width='100%', dpi=150}
library(tidytext)

list_of_tibbles <- cancer_dfs_facet$data
combined_data <- bind_rows(list_of_tibbles)

# Create plot
one_plot <- ggplot(combined_data, aes(x = reorder_within(mutation, freq, cancer_type), y = freq)) + # nolint: object_usage_linter.
  geom_bar(stat = "identity", fill = "blue", width = 0.7) +
  coord_flip() +
  labs(x = "Mutation", y = "Frequency") +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid.major.y = element_blank()
  ) +
  facet_wrap(~cancer_type, scales = "free_y")
pdf("plots/one_plot.pdf")

one_plot
dev.off()
```

```{r top_ten}
library(tidytext)
library(data.table)

list_of_tibbles <- cancer_dfs_facet$data
combined_data <- bind_rows(list_of_tibbles)

# # Make dt with top ten most frequent genes
all_dt <- as.data.table(combined_data)
all_dt[, gene := tstrsplit(mutation, split = ",")[[1]]]

top_num <- 10

topten <- all_dt[, .(n = .N, mean_freq = mean(freq)), by = gene][order(-n)][1:top_num]

# Generate colors
color_pal <- rainbow(10)

topten <- topten[, bar_color := color_pal]

all_dt[, bar_color := ifelse(gene %in% topten$gene, gene, "No")]

color_pal <- append(color_pal, "#ffffffef")

# Create plot
top_ten_oneplot <- ggplot(all_dt, aes(x = reorder_within(mutation, freq, cancer_type), y = freq, fill = bar_color)) + # nolint: object_usage_linter.
  geom_bar(stat = "identity", width = 0.7) +
  coord_flip() +
  labs(x = "Mutation", y = "Frequency") +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid.major.y = element_blank(),
    legend.title = element_blank(),
  ) +
  facet_wrap(~cancer_type, scales = "free_y") +
  scale_fill_manual(values = color_pal, breaks = c(topten$gene))


pdf("plots/top_ten_oneplot.pdf")

top_ten_oneplot
dev.off()
```

```{r add_tert}
# Liver HCC 53/317
```

```{r greedy-algo}
greedy_panel_curator <- function(mutation_data, patient_data, top_number) {
  panel <- data.table(mutation = character())
  top_mutation <- mutation_data[1]
  remaining_mutations <- mutation_data[mutation != top_mutation]

  panel <- rbind(panel, top_mutation)
  for (i in 1:top_number) {
    # This is wrong, should be the coverage at this moment i.e. coverage of number 1 in the first loop and updated for every loop, may want to include number of unique hits
    coverage <- patient_data[, sum(sapply(mutations, function(x) top_mutation %in% x))]
    next_top_mutation <- NA
    for (mut in remaining_mutations) {
      # These hits are not unique, make them so that they are unique and compare with the current hits
      current_coverage <- patient_data[, sum(sapply(mutations, function(x) mut %in% x))]

      if (current_coverage > coverage) {
        coverage <- current_coverage
        next_top_mutation <- mut
      }
    }
    remaining_mutations <- remaining_mutations[mutation != next_top_mutation]
    panel <- rbind(panel, next_top_mutation)
    # Wait what if I just return the coverage here
  }

  return(panel)
}
```

```{r get-data}
library(data.table)

cancer_data <- as.data.frame(tcga_available())

patient_data <- data.table()

for (i in seq_along(cancer_data$Study_Abbreviation)) {
  cancer_type <- cancer_data$Study_Abbreviation[i]
  test_mutations <- tcga_load(study = cancer_type)
  test_data <- as.data.table(test_mutations@data)
  current_data <- test_data[, c("Tumor_Sample_Barcode", "Hugo_Symbol", "HGVSc")]
  current_data <- current_data[, cancer_type := cancer_type]

  patient_data <- rbind(patient_data, current_data)
}

# Add patient and mutation columns
patient_mutation <- patient_data[, .(patient = tstrsplit(Tumor_Sample_Barcode, "-")[[3]], mutation = paste(Hugo_Symbol, HGVSc, sep = ", "), cancer_type)]

# Group mutations into list per unique patient + count number of mutations per patient
unique_patient_data <- patient_mutation[, .(mutations = list(mutation)), by = patient]

# Generate panel
greedy_panel_curator(patient_mutation, unique_patient_data, 10)
```

```{r summary-stats}
library(viridis)
library(tidytext)
library(data.table)
library(tidyverse)

cancer_data <- as.data.frame(tcga_available())

top_nums <- c(10, 20, 50, 100)

top_nums_minus_first <- top_nums[-1]

all_tops <- data.table(mutation = character(), n = integer(), top_number = integer())
all_unique_patient_data <- data.table(patient = character(), mutations = list())

coverage_within_cancer_type <- data.table(cancer_type = character(), coverage = numeric(), top_number = integer())
hits_within_cancer_type <- data.table(cancer_type = character(), hits = numeric(), frequency_of_hit = numeric(), perc_freq_hit = numeric(), top_number = integer())
cancer_specific_total_hits <- data.table()

for (i in seq_along(cancer_data$Study_Abbreviation)) {
  cancer_type <- cancer_data$Study_Abbreviation[i]
  test_mutations <- tcga_load(study = cancer_type)
  test_data <- as.data.table(test_mutations@data)
  patient_data <- test_data[, c("Tumor_Sample_Barcode", "Hugo_Symbol", "HGVSc")]

  # Add patient and mutation columns
  patient_mutation <- patient_data[, .(patient = tstrsplit(Tumor_Sample_Barcode, "-")[[3]], mutation = paste(Hugo_Symbol, HGVSc, sep = ", "))]

  # Group mutations into list per unique patient + count number of mutations per patient
  unique_patient_data <- patient_mutation[, .(mutations = list(mutation)), by = patient]

  for (num in top_nums) {
    top_nucleotides <- patient_mutation[, .(n = .N, top_number = num), by = mutation][order(-n)][1:num]

    within_cancer_patient_hits <- unique_patient_data[, .(
      patient,
      mutations,
      top_number = num,
      hits = sapply(mutations, function(x) length(intersect(x, top_nucleotides$mutation)))
    )]

    total_num_patients <- within_cancer_patient_hits[, .N]

    more_than_zero <- within_cancer_patient_hits[hits > 0, .N] / total_num_patients * 100

    new_row <- data.table(cancer_type = cancer_type, coverage = more_than_zero, top_number = num)

    coverage_within_cancer_type <- rbind(coverage_within_cancer_type, new_row)

    cumulated_hits <- within_cancer_patient_hits[, .(frequency_of_hit = .N), by = hits]
    new_hits <- cumulated_hits[, .(hits, frequency_of_hit, perc_freq_hit = frequency_of_hit / total_num_patients * 100, top_number = num, cancer_type = cancer_type)]

    hits_within_cancer_type <- rbind(hits_within_cancer_type, new_hits)

    all_tops <- rbind(all_tops, top_nucleotides)

    cancer_specific_total_hits <- rbind(cancer_specific_total_hits, within_cancer_patient_hits[, cancer_type := cancer_type])
  }

  all_unique_patient_data <- rbind(all_unique_patient_data, unique_patient_data)
}

coverage_within_cancer_type <- coverage_within_cancer_type[order(-coverage, -top_number)]

# Reorder the cancer_type factor based on the coverage
coverage_within_cancer_type[, cancer_type := factor(cancer_type, levels = unique(cancer_type))]
coverage_within_cancer_type[, top_number := factor(top_number, levels = unique(top_number))]

coverage_within_cancer_plot <- ggplot(coverage_within_cancer_type, aes(x = cancer_type, y = coverage, fill = top_number)) +
  geom_bar(stat = "identity", position = "identity", width = 0.9) +
  labs(title = "Cancer-specific Panel Coverage", x = "Cancer Type", y = "Percentage Coverage", fill = "Number of\nTop Mutations") +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 7),
    axis.text.x = element_text(size = 7, angle = 90, vjust = 0.5, hjust = 1)
  ) +
  scale_y_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100))


pdf("plots/coverage_within_cancer_types_plot.pdf")
coverage_within_cancer_plot
dev.off()

# Make mutations unique
all_tops_unique <- all_tops[, .(n = sum(n)), by = .(mutation, top_number)][order(-n)]

# Duplicate mutations for each top_number, yea i actually dk why i did this, what's this for??
patient_data_all <- all_unique_patient_data[, top_number := 10]

patient_data_expanded <- patient_data_all[rep(seq_len(.N), each = 4)]

topnum_assignment <- rep(c(patient_data_all$top_number[1], top_nums_minus_first), length.out = nrow(patient_data_expanded))

patient_data_expanded[, top_number := topnum_assignment][order(patient)]

# # Find hits - this is the next step to change
# patient_hits <- patient_data_expanded[, hits := sapply(mutations, function(x) length(intersect(x, all_topten$mutation)))][order(-hits)]

patient_hits <- data.table(patient = character(), mutations = list(), top_number = numeric(), hits = integer())
pan_can_fractions <- numeric(length(top_nums))

for (i in seq_along(top_nums)) {
  num <- top_nums[i]

  subset_tops <- all_tops_unique[top_number == num]
  # Calculate hits for the current top_number
  current_patient_hits <- patient_data_expanded[top_number == num, .(
    patient,
    mutations,
    top_number = num,
    hits = sapply(mutations, function(x) length(intersect(x, subset_tops$mutation)))
  )]

  # Calculate fraction_covered for current_patient_hits
  pan_can_fractions[i] <- current_patient_hits[hits > 0, .N] / current_patient_hits[, .N] * 100

  # # Make master list, why do i need this again?
  # patient_hits <- rbind(patient_hits, current_patient_hits)
}

# Coverage per cancer type
coverage_per_cancer <- data.table(cancer_type = character(), coverage = numeric(), top_number = integer())

# append pan_cancer
pan_can_row <- data.table(cancer_type = "PAN-CAN", coverage = pan_can_fractions, top_number = top_nums)
coverage_per_cancer <- rbind(coverage_per_cancer, pan_can_row)

# append all cancer types
for (i in seq_along(cancer_data$Study_Abbreviation)) {
  cancer_type <- cancer_data$Study_Abbreviation[i]
  test_mutations <- tcga_load(study = cancer_type)
  test_data <- as.data.table(test_mutations@data)
  patient_data <- test_data[, c("Tumor_Sample_Barcode", "Hugo_Symbol", "HGVSc")]

  # Add patient and mutation columns
  patient_mutation <- patient_data[, .(patient = tstrsplit(Tumor_Sample_Barcode, "-")[[3]], mutation = paste(Hugo_Symbol, HGVSc, sep = ", "))]

  # Group mutations into list per unique patient + count number of mutations per patient
  unique_patient_data <- patient_mutation[, .(mutations = list(mutation)), by = patient]

  for (num in top_nums) {
    subset_tops <- all_tops_unique[top_number == num]

    per_cancer_patient_hits <- unique_patient_data[, .(
      patient,
      mutations,
      top_number = num,
      hits = sapply(mutations, function(x) length(intersect(x, subset_tops$mutation)))
    )]

    more_than_zero <- per_cancer_patient_hits[hits > 0, .N] / per_cancer_patient_hits[, .N] * 100

    new_row <- data.table(cancer_type = cancer_type, coverage = more_than_zero, top_number = num)

    coverage_per_cancer <- rbind(coverage_per_cancer, new_row)
  }
}

coverage_per_cancer <- coverage_per_cancer[order(-coverage, -top_number)]

# Reorder the cancer_type factor based on the coverage
coverage_per_cancer[, cancer_type := factor(cancer_type, levels = unique(cancer_type))]
coverage_per_cancer[, top_number := factor(top_number, levels = unique(top_number))]

# Extract the viridis colors and reverse them
num_levels <- length(unique(coverage_per_cancer$top_number))
reversed_viridis_colors <- rev(viridis(num_levels))

coverage_per_cancer_plot <- ggplot(coverage_per_cancer, aes(x = cancer_type, y = coverage, fill = top_number)) +
  geom_bar(stat = "identity", position = "identity", width = 0.9) +
  labs(title = "Percentage Coverage Pan-Can Panel", x = "Cancer Type", y = "Percentage Coverage", fill = "Number of\nTop Mutations") +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 7),
    axis.text.x = element_text(size = 7, angle = 90, vjust = 0.5, hjust = 1)
  ) +
  scale_fill_manual(values = reversed_viridis_colors) +
  scale_y_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100))


pdf("plots/coverage_per_cancer_plot.pdf")
coverage_per_cancer_plot
dev.off()
```


```{r pie_chart}
# # Create plot
# ggplot(combined_data, aes(x = reorder_within(mutation, freq, cancer_type), y = freq)) + # nolint: object_usage_linter.
#   geom_bar(stat = "identity", fill = "blue", width = 0.9) +
#   geom_text(aes(label = round(freq, 3)), size = 1.5, hjust = 1.2, color = "white") +
#   coord_flip() +
#   labs(x = "Mutation", y = "Frequency") +
#   facet_wrap(~cancer_type, scales = "free") +
#   theme_minimal() +
#   scale_x_reordered() +
#   theme(
#     axis.text.y = element_text(size = 7),
#     axis.text.x = element_text(size = 5)
#   )

# # This is for a pie chart and cumulative frequency plot, only suitable for one top number
# grouped_data <- patient_hits[, .(count = .N), by = .(hits > 0)]

# grouped_data[, group := ifelse(hits == TRUE, "Hit", "No Hit")]
# grouped_data[, prop := count / sum(count) * 100]

# grouped_data[, ypos := -((cumsum(count) - 0.5 * count) - sum(count))]
# grouped_data[order(-count)]

# fraction_pie <- ggplot(grouped_data, aes(x = "", y = count, fill = group)) +
#   geom_bar(stat = "identity", width = 1) +
#   coord_polar("y", start = 0) +
#   theme_void() +
#   theme(legend.position = "none") +
#   geom_text(aes(y = ypos, label = paste0(group, "\n", round(prop, 1), "%")), color = "black", size = 6) +
#   scale_fill_manual(values = c("Hit" = "#73daff", "No Hit" = "#ff6961"))

# pdf("plots/fraction_covered_pie.pdf")

# fraction_pie
# dev.off()

# cumulative_freq_plot <- ggplot(patient_hits, aes(hits, y = 1 - after_stat(y))) +
#   stat_ecdf(geom = "step", color = "purple", linewidth = 1) +
#   labs(x = "Number of Hits", y = "%") +
#   scale_y_continuous(breaks = seq(0, 1, 0.1), labels = seq(0, 100, 10)) +
#   scale_x_continuous(breaks = seq(0, max(patient_hits$hits), 1)) +
#   theme_minimal()

# pdf("plots/cumulative_freq_plot.pdf")
# cumulative_freq_plot
# dev.off()
```

```{r pan-cancer-data}
# Get all cancer types
cancer_types <- unique(cancer_data$Study_Abbreviation)

# Function to load mutations individually because TCGAmutations does not support loading all
load_mutations <- function(cancer_type) {
  mutations <- tcgaLoad(study = cancer_type) # nolint: object_usage_linter.
  mutation_data <- as.data.frame(mutations@data)
  mutation_data$cancer_type <- cancer_type
  return(mutation_data)
}

pan_cancer_list <- lapply(cancer_types, load_mutations)

pan_cancer_df <- bind_rows(pan_cancer_list)
```


```{r clean-pan-cancer-data}
nucleotide_changes <- pan_cancer_df[, c("Hugo_Symbol", "HGVSc", "cancer_type")]

tumor_samples <- pan_cancer_df[, c("Tumor_Sample_Barcode")]

num_tumors <- length(unique(tumor_samples))

# group_by HGVSc and add frequency using mutate, then ungroup
df <- nucleotide_changes %>%
  mutate(mutation = paste(Hugo_Symbol, HGVSc, sep = ", ")) %>%
  group_by(mutation) %>%
  mutate(freq = n()) %>%
  ungroup()

# sort in descending order, distinct removes duplicate rows
df_sorted <- df %>%
  arrange(desc(freq)) %>%
  distinct(mutation, .keep_all = TRUE)

df_merged <- df_sorted %>%
  select(mutation, freq, cancer_type)

df_merged_trunc <- df_merged[1:50, ]

# Convert the mutation column to a factor
df_merged_trunc$mutation <- factor(df_merged_trunc$mutation, levels = df_merged$mutation)
df_merged_trunc$freq <- df_merged_trunc$freq / num_tumors




all_mutations <- as.data.table(select(df_merged, mutation, freq))

patient_hits <- data.table(patient = character(), mutations = list(), top_number = numeric(), hits = integer())
pan_can_fractions <- numeric(length(top_nums))

for (i in seq_along(top_nums)) {
  num <- top_nums[i]

  current_top <- all_mutations[order(-freq)][1:num]

  # Calculate hits for the current top_number
  current_patient_hits <- all_unique_patient_data[, .(
    patient,
    mutations,
    top_number = num,
    hits = sapply(mutations, function(x) length(intersect(x, current_top$mutation)))
  )]

  # Calculate fraction_covered for current_patient_hits
  pan_can_fractions[i] <- current_patient_hits[hits > 0, .N] / current_patient_hits[, .N] * 100
}


pan_can_tops <- data.table(cancer_type = character(), coverage = numeric(), top_number = integer())

# append pan_cancer
pan_can_row <- data.table(cancer_type = "PAN-CAN", coverage = pan_can_fractions, top_number = top_nums)
pan_can_tops <- rbind(pan_can_tops, pan_can_row)

hits_pan_can <- data.table(cancer_type = character(), hits = numeric(), frequency_of_hit = numeric(), perc_freq_hit = numeric(), top_number = integer())
pancan_total_hits <- data.table()

top_nums <- c(10, 20, 50, 100)

for (i in seq_along(cancer_data$Study_Abbreviation)) {
  cancer_type <- cancer_data$Study_Abbreviation[i]
  test_mutations <- tcga_load(study = cancer_type)
  test_data <- as.data.table(test_mutations@data)
  patient_data <- test_data[, c("Tumor_Sample_Barcode", "Hugo_Symbol", "HGVSc")]

  # Add patient and mutation columns
  patient_mutation <- patient_data[, .(patient = tstrsplit(Tumor_Sample_Barcode, "-")[[3]], mutation = paste(Hugo_Symbol, HGVSc, sep = ", "))]

  # Group mutations into list per unique patient + count number of mutations per patient
  unique_patient_data <- patient_mutation[, .(mutations = list(mutation)), by = patient]


  for (num in top_nums) {
    current_top <- all_mutations[order(-freq)][1:num]

    per_cancer_patient_hits <- unique_patient_data[, .(
      patient,
      mutations,
      top_number = num,
      hits = sapply(mutations, function(x) length(intersect(x, current_top$mutation)))
    )]

    total_num_patients <- per_cancer_patient_hits[, .N]
    more_than_zero <- per_cancer_patient_hits[hits > 0, .N] / total_num_patients * 100

    new_row <- data.table(cancer_type = cancer_type, coverage = more_than_zero, top_number = num)

    pan_can_tops <- rbind(pan_can_tops, new_row)

    cumulated_hits <- per_cancer_patient_hits[, .(frequency_of_hit = .N), by = hits]
    new_hits <- cumulated_hits[, .(hits, frequency_of_hit, perc_freq_hit = frequency_of_hit / total_num_patients * 100, top_number = num, cancer_type = cancer_type)]

    hits_pan_can <- rbind(hits_pan_can, new_hits)

    pancan_total_hits <- rbind(pancan_total_hits, per_cancer_patient_hits[, cancer_type := cancer_type])
  }
}

pan_can_tops <- pan_can_tops[order(-coverage, -top_number)]

# Reorder the cancer_type factor based on the coverage
pan_can_tops[, cancer_type := factor(cancer_type, levels = unique(cancer_type))]
pan_can_tops[, top_number := factor(top_number, levels = unique(top_number))]

num_levels <- length(unique(pan_can_tops$top_number))
reversed_viridis_colors <- rev(viridis(num_levels))

coverage_within_cancer_plot <- ggplot(pan_can_tops, aes(x = cancer_type, y = coverage, fill = top_number)) +
  geom_bar(stat = "identity", position = "identity", width = 0.9) +
  labs(title = "Pan-Can Panel Coverage", x = "Cancer Type", y = "Percentage Coverage", fill = "Number of\nTop Mutations") +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 7),
    axis.text.x = element_text(size = 7, angle = 90, vjust = 0.5, hjust = 1)
  ) +
  scale_y_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_fill_manual(values = reversed_viridis_colors)


pdf("plots/pan-can_panel_coverage.pdf")
coverage_within_cancer_plot
dev.off()
```

```{r plot-pan-cancer, fig.width=20, fig.height=14, out.width='100%', dpi=150}
pancan_plot <- ggplot(data = df_merged_trunc, aes(x = mutation, y = freq)) +
  geom_bar(stat = "identity", fill = "blue") +
  geom_text(aes(label = round(freq, 3)), size = 3.5, hjust = 1.2, color = "white") +
  coord_flip() +
  labs(x = "Mutation", y = "Frequency", title = "Pan-cancer Frequency of Mutations") +
  theme_minimal()

pdf("plots/pancan_plot.pdf")

pancan_plot
dev.off()
```

```{r diagnostic-plots}
# Diagnostic plots - distribution of hits
library(glue)

for (num in top_nums) {
  cancer_specific_hits <- hits_within_cancer_type[top_number == num]
  cancer_specific_hits[, hit_type := "Cancer Specific"]
  pan_can_hits <- hits_pan_can[top_number == num]
  pan_can_hits[, hit_type := "Pan-Cancer"]

  current_all_hits <- rbind(cancer_specific_hits, pan_can_hits)

  distribution_plot <- ggplot(current_all_hits, aes(x = hits, y = perc_freq_hit, colour = hit_type, group = hit_type)) +
    geom_point() +
    geom_line() +
    labs(title = glue("Distribution of Hits of Top {num} Mutations"), y = "% Frequency", x = "Number of Hits") +
    theme_minimal() +
    theme(
      axis.ticks.x = element_blank(),
      axis.ticks.y = element_blank(),
      panel.grid.major.y = element_blank(),
      legend.title = element_blank(),
    ) +
    facet_wrap(~cancer_type, scales = "free_x")

  pdf(glue("plots/diagnostic-plots/hit-distribution-top-{num}.pdf"))
  print(distribution_plot)
  dev.off()
}

# Targeted plots
targeted_hits_within <- hits_within_cancer_type[cancer_type %in% c("UCEC", "STAD", "LUSC", "BRCA")]
targeted_hits_pancan <- hits_pan_can[cancer_type %in% c("UCEC", "STAD", "LUSC", "BRCA")]
for (num in top_nums) {
  cancer_specific_hits <- targeted_hits_within[top_number == num]
  cancer_specific_hits[, hit_type := "Cancer Specific"]
  pan_can_hits <- targeted_hits_pancan[top_number == num]
  pan_can_hits[, hit_type := "Pan-Cancer"]

  current_all_hits <- rbind(cancer_specific_hits, pan_can_hits)

  distribution_plot <- ggplot(current_all_hits, aes(x = hits, y = perc_freq_hit, colour = hit_type, group = hit_type)) +
    geom_point() +
    geom_line() +
    labs(title = glue("Distribution of Hits of Top {num} Mutations"), y = "% Frequency", x = "Number of Hits") +
    theme_minimal() +
    theme(
      axis.ticks.x = element_blank(),
      axis.ticks.y = element_blank(),
      panel.grid.major.y = element_blank(),
      legend.title = element_blank(),
    ) +
    facet_wrap(~cancer_type, scales = "free_x")

  pdf(glue("plots/diagnostic-plots/targeted-hit-distribution-top-{num}.pdf"))
  print(distribution_plot)
  dev.off()
}

# Density
total_targeted_hits_within <- cancer_specific_total_hits[cancer_type %in% c("UCEC", "STAD", "LUSC", "BRCA")]
total_targeted_hits_pancan <- pancan_total_hits[cancer_type %in% c("UCEC", "STAD", "LUSC", "BRCA")]

for (num in top_nums) {
  cancer_specific_hits <- total_targeted_hits_within[top_number == num]
  cancer_specific_hits[, hit_type := "Cancer Specific"]
  pan_can_hits <- total_targeted_hits_pancan[top_number == num]
  pan_can_hits[, hit_type := "Pan-Cancer"]

  current_all_hits <- rbind(cancer_specific_hits, pan_can_hits)

  distribution_plot <- ggplot(current_all_hits, aes(x = hits, fill = hit_type, group = hit_type)) +
    geom_density(alpha = 0.6) +
    labs(title = glue("Distribution of Hits of Top {num} Mutations"), x = "Number of Hits") +
    theme_minimal() +
    theme(
      axis.ticks.x = element_blank(),
      axis.ticks.y = element_blank(),
      panel.grid.major.y = element_blank(),
      legend.title = element_blank(),
    ) +
    facet_wrap(~cancer_type, scales = "free")

  pdf(glue("plots/diagnostic-plots/density-hit-distribution-top-{num}.pdf"))
  print(distribution_plot)
  dev.off()
}
```

```{r debug}
# Coverage within cancer types
cancer_data <- as.data.frame(tcga_available())

top_nums <- c(10, 20, 50, 100)

top_nums_minus_first <- top_nums[-1]

all_tops <- data.table(mutation = character(), n = integer(), top_number = integer())
all_unique_patient_data <- data.table(patient = character(), mutations = list())

coverage_within_cancer_type <- data.table(cancer_type = character(), coverage = numeric(), top_number = integer())


cancer_type <- "UCEC"
test_mutations <- tcga_load(study = cancer_type)
test_data <- as.data.table(test_mutations@data)
patient_data <- test_data[, c("Tumor_Sample_Barcode", "Hugo_Symbol", "HGVSc")]

# Add patient and mutation columns
patient_mutation <- patient_data[, .(patient = tstrsplit(Tumor_Sample_Barcode, "-")[[3]], mutation = paste(Hugo_Symbol, HGVSc, sep = ", "))]

# Group mutations into list per unique patient + count number of mutations per patient
unique_patient_data <- patient_mutation[, .(mutations = list(mutation)), by = patient]

for (num in top_nums) {
  top_nucleotides <- patient_mutation[, .(n = .N, top_number = num), by = mutation][order(-n)][1:num]

  within_cancer_patient_hits <- unique_patient_data[, .(
    patient,
    mutations,
    top_number = num,
    hits = sapply(mutations, function(x) length(intersect(x, top_nucleotides$mutation)))
  )]

  more_than_zero <- within_cancer_patient_hits[, sum(hits)] / within_cancer_patient_hits[, .N] * 100

  new_row <- data.table(cancer_type = cancer_type, coverage = more_than_zero, top_number = num)

  coverage_within_cancer_type <- rbind(coverage_within_cancer_type, new_row)

  all_tops <- rbind(all_tops, top_nucleotides)
}

# pan-can panel
all_mutations <- data.table(mutation = character(), n = integer())

for (i in seq_along(cancer_data$Study_Abbreviation)) {
  # Load TCGA mutation data
  cancer_type <- cancer_data$Study_Abbreviation[i]
  cancer_name <- gsub("_", " ", cancer_data$Study_Name[i])
  mutations <- tcgaLoad(study = cancer_type)
  mutation_data <- as.data.table(mutations@data)
  nucleotide_changes <- mutation_data[, c("Hugo_Symbol", "HGVSc")]

  nucleotide_changes[, mutation := paste(Hugo_Symbol, HGVSc, sep = ", ")]
  mutation_counts <- nucleotide_changes[, .(n = .N), by = mutation]

  all_mutations <- rbind(all_mutations, mutation_counts)
}

all_mutations <- all_mutations[, .(n = sum(n)), by = mutation][order(-n)]

patient_hits <- data.table(patient = character(), mutations = list(), top_number = numeric(), hits = integer())
pan_can_fractions <- numeric(length(top_nums))

for (i in seq_along(top_nums)) {
  num <- top_nums[i]

  current_top <- all_mutations[order(-n)][1:num]

  # Calculate hits for the current top_number
  current_patient_hits <- unique_patient_data[, .(
    patient,
    mutations,
    top_number = num,
    hits = sapply(mutations, function(x) length(intersect(x, current_top$mutation)))
  )]

  # Calculate fraction_covered for current_patient_hits
  pan_can_fractions[i] <- current_patient_hits[, sum(hits)] / current_patient_hits[, .N]
}


pan_can_tops <- data.table(cancer_type = character(), coverage = numeric(), top_number = integer())

# append pan_cancer
pan_can_row <- data.table(cancer_type = "UCEC-pan", coverage = pan_can_fractions, top_number = top_nums)


coverage_within_cancer_type <- rbind(coverage_within_cancer_type, pan_can_row)

coverage_within_cancer_type <- coverage_within_cancer_type[order(-coverage, -top_number)]

# Reorder the cancer_type factor based on the coverage
coverage_within_cancer_type[, cancer_type := factor(cancer_type, levels = unique(cancer_type))]
coverage_within_cancer_type[, top_number := factor(top_number, levels = unique(top_number))]

coverage_within_cancer_plot <- ggplot(coverage_within_cancer_type, aes(x = cancer_type, y = coverage, fill = top_number)) +
  geom_bar(stat = "identity", position = "identity", width = 0.9) +
  labs(title = "weird", x = "Cancer Type", y = "Percentage Coverage", fill = "Number of\nTop Mutations") +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 7),
    axis.text.x = element_text(size = 7, angle = 90, vjust = 0.5, hjust = 1)
  )


pdf("plots/coverage_within_cancer_types_ucec.pdf")
coverage_within_cancer_plot
dev.off()




density_plot <- ggplot(within_cancer_patient_hits, aes(x = mutation_count)) +
  geom_density(fill = "#69b3a2", color = "#e9ecef", alpha = 0.8)
pdf("plots/density.pdf")
density_plot
dev.off()

# pan-can panel
all_mutations <- data.table(mutation = character(), n = integer())

for (i in seq_along(cancer_data$Study_Abbreviation)) {
  # Load TCGA mutation data
  cancer_type <- cancer_data$Study_Abbreviation[i]
  cancer_name <- gsub("_", " ", cancer_data$Study_Name[i])
  mutations <- tcgaLoad(study = cancer_type)
  mutation_data <- as.data.table(mutations@data)
  nucleotide_changes <- mutation_data[, c("Hugo_Symbol", "HGVSc")]

  nucleotide_changes[, mutation := paste(Hugo_Symbol, HGVSc, sep = ", ")]
  mutation_counts <- nucleotide_changes[, .(n = .N), by = mutation]

  all_mutations <- rbind(all_mutations, mutation_counts)
}

all_mutations <- all_mutations[, .(n = sum(n)), by = mutation][order(-n)]

patient_hits <- data.table(patient = character(), mutations = list(), top_number = numeric(), hits = integer())
pan_can_fractions <- numeric(length(top_nums))

for (i in seq_along(top_nums)) {
  num <- top_nums[i]

  current_top <- all_mutations[order(-n)][1:num]

  # Calculate hits for the current top_number
  current_patient_hits <- unique_patient_data[, .(
    patient,
    mutations,
    top_number = num,
    hits = sapply(mutations, function(x) length(intersect(x, current_top$mutation)))
  )]

  # Calculate fraction_covered for current_patient_hits
  pan_can_fractions[i] <- current_patient_hits[hits > 0, .N] / current_patient_hits[, .N] * 100
}


pan_can_tops <- data.table(cancer_type = character(), coverage = numeric(), top_number = integer())

# append pan_cancer
pan_can_row <- data.table(cancer_type = "UCEC-pan", coverage = pan_can_fractions, top_number = top_nums)
pan_can_tops <- rbind(pan_can_tops, pan_can_row)

top_nums <- c(10, 20, 50, 100)


cancer_type <- "UCEC"
test_mutations <- tcga_load(study = cancer_type)
test_data <- as.data.table(test_mutations@data)
patient_data <- test_data[, c("Tumor_Sample_Barcode", "Hugo_Symbol", "HGVSc")]

# Add patient and mutation columns
patient_mutation <- patient_data[, .(patient = tstrsplit(Tumor_Sample_Barcode, "-")[[3]], mutation = paste(Hugo_Symbol, HGVSc, sep = ", "))]

# Group mutations into list per unique patient + count number of mutations per patient
unique_patient_data <- patient_mutation[, .(mutations = list(mutation)), by = patient]


for (num in top_nums) {
  current_top <- all_mutations[order(-n)][1:num]

  per_cancer_patient_hits <- unique_patient_data[, .(
    patient,
    mutations,
    top_number = num,
    hits = sapply(mutations, function(x) length(intersect(x, current_top$mutation)))
  )]
  more_than_zero <- per_cancer_patient_hits[hits > 0, .N] / per_cancer_patient_hits[, .N] * 100

  new_row <- data.table(cancer_type = cancer_type, coverage = more_than_zero, top_number = num)

  pan_can_tops <- rbind(pan_can_tops, new_row)
}

pan_can_tops <- pan_can_tops[order(-coverage, -top_number)]

# Reorder the cancer_type factor based on the coverage
pan_can_tops[, cancer_type := factor(cancer_type, levels = unique(cancer_type))]
pan_can_tops[, top_number := factor(top_number, levels = unique(top_number))]

num_levels <- length(unique(pan_can_tops$top_number))
reversed_viridis_colors <- rev(viridis(num_levels))

coverage_within_cancer_plot <- ggplot(pan_can_tops, aes(x = cancer_type, y = coverage, fill = top_number)) +
  geom_bar(stat = "identity", position = "identity", width = 0.9) +
  labs(title = "Pan-Can Panel Coverage", x = "Cancer Type", y = "Percentage Coverage", fill = "Number of\nTop Mutations") +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 7),
    axis.text.x = element_text(size = 7, angle = 90, vjust = 0.5, hjust = 1)
  ) +
  scale_y_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_fill_manual(values = reversed_viridis_colors)


pdf("plots/pan-can_panel_ucec.pdf")
coverage_within_cancer_plot
dev.off()
```